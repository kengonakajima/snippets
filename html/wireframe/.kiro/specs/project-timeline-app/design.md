# 設計書

## 概要

プロジェクトタイムラインWebアプリケーションは、既存のHTMLファイルをベースに、ローカル開発サーバーとデータ永続化機能を追加して完全に動作するアプリケーションにします。Node.jsベースの軽量なHTTPサーバーを使用し、ブラウザのlocalStorageでデータを管理します。

## アーキテクチャ

### システム構成

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ブラウザ      │    │  Node.js        │    │  ローカル       │
│                 │    │  HTTPサーバー   │    │  ストレージ     │
│ - HTML/CSS/JS   │◄──►│                 │◄──►│                 │
│ - localStorage  │    │ - 静的ファイル  │    │ - JSON ファイル │
│ - marked.js     │    │   配信          │    │ - 設定ファイル  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 技術スタック

- **フロントエンド**: HTML5, CSS3, Vanilla JavaScript
- **Markdownパーサー**: marked.js (CDN経由)
- **バックエンド**: Node.js + Express.js
- **データストレージ**: ブラウザのlocalStorage + JSONファイル
- **開発ツール**: npm scripts

## コンポーネントと インターフェース

### 1. HTTPサーバー (server.js)

**責任**:
- 静的ファイル（HTML, CSS, JS）の配信
- APIエンドポイントの提供
- 自動ブラウザ起動

**主要メソッド**:
- `startServer()`: サーバー起動
- `serveStaticFiles()`: 静的ファイル配信
- `handleAPI()`: API リクエスト処理

### 2. データ管理モジュール (data-manager.js)

**責任**:
- Markdownコンテンツの保存・読み込み
- タイムライン投稿の管理
- localStorage との同期

**主要メソッド**:
- `saveMarkdownContent(pane, content)`: Markdownコンテンツ保存
- `loadMarkdownContent(pane)`: Markdownコンテンツ読み込み
- `savePost(post)`: 投稿保存
- `loadPosts()`: 投稿一覧取得

### 3. UI管理モジュール (ui-manager.js)

**責任**:
- Markdownエディタの表示・非表示
- 投稿フォームの処理
- リアルタイムプレビュー
- 全画面編集モードの管理

**主要メソッド**:
- `enableEditMode(pane)`: 編集モード有効化（右側ペイン全体を使用）
- `exitEditMode()`: 編集モード終了（タイムラインに復帰）
- `saveAndRender(pane, content)`: 保存とレンダリング
- `addNewPost(content)`: 新規投稿追加
- `renderTimeline()`: タイムライン再描画
- `toggleFullscreenEditor()`: 全画面エディタの切り替え

## UI設計詳細

### Markdownエディタの全画面表示

**編集モード時のレイアウト**:
- 左側ペイン: 通常通り表示（320px幅）
- 右側ペイン: タイムラインを隠してMarkdownエディタを全画面表示

**エディタUI構成**:
```
┌─────────────────────────────────────────────────────────────┐
│ エディタヘッダー                                            │
│ ┌─────────────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│ │ 編集中: [ペイン名] │ │プレビュー│ │キャンセル│ │  保存   │   │
│ └─────────────────┘ └─────────┘ └─────────┘ └─────────┘   │
├─────────────────────────────────────────────────────────────┤
│ エディタ本体                                                │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │  Markdownテキストエリア                                 │ │
│ │  (全画面サイズ、リサイズ可能)                           │ │
│ │                                                         │ │
│ │                                                         │ │
│ │                                                         │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ プレビューエリア (プレビューモード時のみ表示)              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ レンダリングされたMarkdown                              │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**状態管理**:
- `isFullscreenEditing`: 全画面編集モードの状態
- `currentEditingPane`: 現在編集中のペイン名
- `originalTimelineContent`: タイムライン復帰用の元コンテンツ

**アニメーション**:
- 編集モード開始: タイムラインがフェードアウト、エディタがフェードイン
- 編集モード終了: エディタがフェードアウト、タイムラインがフェードイン
- 遷移時間: 300ms

## データモデル

### Markdownコンテンツ

```javascript
{
  outline: "# プロジェクト概要\n...",
  todo: "## 今週のタスク\n...",
  pinned: "## 重要な情報\n..."
}
```

### タイムライン投稿

```javascript
{
  id: "unique-id",
  content: "投稿内容",
  author: "ユーザー名",
  timestamp: "2025-01-15T10:30:00Z",
  avatar: "U"
}
```

### 設定データ

```javascript
{
  serverPort: 3000,
  autoOpenBrowser: true,
  defaultUser: {
    name: "ユーザー",
    avatar: "U"
  }
}
```

## エラーハンドリング

### サーバーエラー

1. **ポート使用中エラー**
   - 代替ポートを自動検索
   - ユーザーに新しいポートを通知

2. **ファイル読み込みエラー**
   - デフォルトコンテンツで初期化
   - エラーログを出力

3. **JSON解析エラー**
   - 破損したデータをリセット
   - バックアップから復元

### クライアントエラー

1. **localStorage容量不足**
   - 古いデータを自動削除
   - ユーザーに警告表示

2. **marked.js読み込み失敗**
   - プレーンテキストで表示
   - 再読み込みを促す

3. **ネットワークエラー**
   - オフラインモードに切り替え
   - ローカルデータのみ使用

## テスト戦略

### 単体テスト

- データ管理モジュールの各メソッド
- UI管理モジュールのDOM操作
- エラーハンドリング機能

### 統合テスト

- サーバー起動からブラウザ表示まで
- データ保存・読み込みの一連の流れ
- Markdownレンダリングの正確性

### 手動テスト

- 各ブラウザでの表示確認
- レスポンシブデザインの動作
- オフライン環境での動作確認

## セキュリティ考慮事項

### XSS対策

- Markdownコンテンツのサニタイゼーション
- HTMLエスケープ処理
- CSP（Content Security Policy）の設定

### データ保護

- ローカルストレージのデータ暗号化（オプション）
- 機密情報の除外
- データバックアップ機能

## パフォーマンス最適化

### フロントエンド

- Markdownレンダリングのデバウンス
- 大量投稿時の仮想スクロール
- 画像の遅延読み込み

### バックエンド

- 静的ファイルのキャッシュ設定
- gzip圧縮の有効化
- 不要なログ出力の削減

## 配布とインストール

### 必要な依存関係

```json
{
  "express": "^4.18.0",
  "open": "^8.4.0",
  "cors": "^2.8.5"
}
```

### インストール手順

1. `npm install` で依存関係をインストール
2. `npm start` でサーバー起動
3. ブラウザが自動的に開く
4. アプリケーション使用開始

### ディレクトリ構造

```
project-timeline-app/
├── package.json
├── server.js
├── public/
│   ├── index.html
│   ├── styles.css
│   ├── app.js
│   └── data-manager.js
├── data/
│   ├── content.json
│   └── posts.json
└── README.md
```