{"version":3,"names":["_module","require","_util","_path","_repl","babel","_vm","_register","_url","_programSetup","program","parse","process","argv","opts","babelOptions","caller","name","extensions","ignore","only","plugins","presets","configFile","envName","rootMode","babelrc","undefined","key","Object","keys","register","hasTopLevelAwait","replPlugin","types","t","visitor","Program","path","node","extra","topLevelAwait","hasExpressionStatement","bodyPath","get","isExpressionStatement","isExportDeclaration","isImportDeclaration","buildCodeFrameError","body","i","length","returnStatement","expression","pushContainer","expressionStatement","identifier","_eval","code","filename","trim","transformSync","assign","parserOpts","allowAwaitOutsideFunction","concat","vm","runInThisContext","eval","print","global","__filename","__dirname","cwd","module","Module","paths","_nodeModulePaths","exports","bind","result","output","inspect","stdout","write","args","slice","ignoreNext","some","arg","i2","parsedOption","options","find","option","long","short","optionName","attributeName","parsedArg","requireArgs","isAbsolute","join","execArgv","push","runMain","replStart","v","w","split","versions","resolve","r","b","M","f","_findPath","Error","replEval","context","callback","err","e","then","catch","replServer","repl","start","prompt","input","stdin","useGlobal","preview","NODE_REPL_HISTORY","env","setupHistory"],"sources":["../src/_babel-node.ts"],"sourcesContent":["import Module from \"node:module\";\nimport { inspect } from \"node:util\";\nimport path from \"node:path\";\nimport repl from \"node:repl\";\nimport * as babel from \"@babel/core\";\nimport vm from \"node:vm\";\nimport \"core-js/stable/index.js\";\nimport \"regenerator-runtime/runtime.js\";\n// @ts-expect-error @babel/register is a CommonJS module\nimport register from \"@babel/register\";\nimport { fileURLToPath } from \"node:url\";\nimport { createRequire } from \"node:module\";\nimport type { PluginAPI, PluginObject } from \"@babel/core\";\n\nimport { program } from \"./program-setup.ts\";\n\nconst require = createRequire(import.meta.url);\n\nprogram.parse(process.argv);\nconst opts = program.opts();\n\nconst babelOptions = {\n  caller: {\n    name: \"@babel/node\",\n  },\n  extensions: opts.extensions,\n  ignore: opts.ignore,\n  only: opts.only,\n  plugins: opts.plugins,\n  presets: opts.presets,\n  configFile: opts.configFile,\n  envName: opts.envName,\n  rootMode: opts.rootMode,\n\n  // Commander will default the \"--no-\" arguments to true, but we want to\n  // leave them undefined so that @babel/core can handle the\n  // default-assignment logic on its own.\n  babelrc: opts.babelrc === true ? undefined : opts.babelrc,\n};\n\nfor (const key of Object.keys(babelOptions) as Array<\n  keyof typeof babelOptions\n>) {\n  if (babelOptions[key] === undefined) {\n    delete babelOptions[key];\n  }\n}\n\nregister(babelOptions);\n\nlet hasTopLevelAwait = false;\n\nconst replPlugin = ({ types: t }: PluginAPI): PluginObject => ({\n  visitor: {\n    Program(path) {\n      hasTopLevelAwait = path.node.extra.topLevelAwait as boolean;\n\n      let hasExpressionStatement: boolean;\n      for (const bodyPath of path.get(\"body\")) {\n        if (bodyPath.isExpressionStatement()) {\n          hasExpressionStatement = true;\n        } else if (\n          bodyPath.isExportDeclaration() ||\n          bodyPath.isImportDeclaration()\n        ) {\n          throw bodyPath.buildCodeFrameError(\n            \"Modules aren't supported in the REPL\",\n          );\n        }\n      }\n\n      if (hasTopLevelAwait) {\n        const body = path.node.body;\n        for (let i = body.length - 1; i >= 0; i--) {\n          if (t.isExpressionStatement(body[i])) {\n            body[i] = t.returnStatement(\n              (body[i] as babel.types.ExpressionStatement).expression,\n            );\n            break;\n          }\n        }\n\n        return;\n      }\n\n      if (hasExpressionStatement) return;\n\n      // If the executed code doesn't evaluate to a value,\n      // prevent implicit strict mode from printing 'use strict'.\n      path.pushContainer(\n        \"body\",\n        t.expressionStatement(t.identifier(\"undefined\")),\n      );\n    },\n  },\n});\n\nconst _eval = function (code: string, filename: string) {\n  code = code.trim();\n  if (!code) return undefined;\n\n  hasTopLevelAwait = false;\n\n  code = babel.transformSync(code, {\n    filename: filename,\n    ...babelOptions,\n    parserOpts: {\n      allowAwaitOutsideFunction: true,\n    },\n    plugins: (opts.plugins || []).concat([replPlugin]),\n  }).code;\n\n  if (hasTopLevelAwait) {\n    code = `(async () => { ${code} })()`;\n  }\n\n  return vm.runInThisContext(code, {\n    filename: filename,\n  });\n};\n\nif (opts.eval || opts.print) {\n  let code = opts.eval;\n  if (!code || code === true) code = opts.print;\n\n  global.__filename = \"[eval]\";\n  global.__dirname = process.cwd();\n\n  const module = new Module(global.__filename);\n  module.filename = global.__filename;\n  // @ts-expect-error todo(flow->ts)\n  module.paths = Module._nodeModulePaths(global.__dirname);\n\n  global.exports = module.exports;\n  global.module = module;\n  global.require = module.require.bind(module);\n\n  const result = _eval(code, global.__filename);\n  if (opts.print) {\n    const output = typeof result === \"string\" ? result : inspect(result);\n    process.stdout.write(output + \"\\n\");\n  }\n} else {\n  if (program.args.length) {\n    // slice all arguments up to the first filename since they're babel args that we handle\n    let args = process.argv.slice(2);\n\n    let i = 0;\n    let ignoreNext = false;\n    args.some(function (arg, i2) {\n      if (ignoreNext) {\n        ignoreNext = false;\n        return;\n      }\n\n      if (arg[0] === \"-\") {\n        const parsedOption = program.options.find((option: any) => {\n          return option.long === arg || option.short === arg;\n        });\n        if (parsedOption === undefined) {\n          return;\n        }\n        const optionName = parsedOption.attributeName();\n        const parsedArg = opts[optionName];\n        if (optionName === \"require\" || (parsedArg && parsedArg !== true)) {\n          ignoreNext = true;\n        }\n      } else {\n        i = i2;\n        return true;\n      }\n    });\n    args = args.slice(i);\n\n    requireArgs();\n\n    // make the filename absolute\n    const filename = args[0];\n    if (!path.isAbsolute(filename)) {\n      args[0] = path.join(process.cwd(), filename);\n    }\n\n    // add back on node and concat the sliced args\n    process.argv = [\"node\", ...args];\n    process.execArgv.push(fileURLToPath(import.meta.url));\n\n    Module.runMain();\n  } else {\n    requireArgs();\n    replStart();\n  }\n}\n\n// We have to handle require ourselves, as we want to require it in the context of babel-register\nfunction requireArgs() {\n  if (opts.require) {\n    require(\n      require.resolve(opts.require, {\n        paths: [process.cwd()],\n      }),\n    );\n  }\n}\nfunction replEval(\n  this: repl.REPLServer,\n  code: string,\n  context: vm.Context,\n  filename: string,\n  callback: (err: Error | null, result: any) => void,\n) {\n  let err;\n  let result;\n\n  try {\n    if (code[0] === \"(\" && code[code.length - 1] === \")\") {\n      code = code.slice(1, -1); // remove \"(\" and \")\"\n    }\n\n    result = _eval(code, filename);\n  } catch (e) {\n    err = e;\n  }\n\n  if (hasTopLevelAwait && !err) {\n    (result as Promise<any>)\n      .then(v => {\n        callback(null, v);\n      })\n      .catch(e => {\n        callback(e, null);\n      });\n  } else {\n    callback(err, result);\n  }\n}\n\nfunction replStart() {\n  const replServer = repl.start({\n    prompt: \"babel > \",\n    input: process.stdin,\n    output: process.stdout,\n    eval: replEval,\n    useGlobal: true,\n    preview: true,\n  });\n  const NODE_REPL_HISTORY = process.env.NODE_REPL_HISTORY;\n  if (process.env.BABEL_8_BREAKING) {\n    replServer.setupHistory(NODE_REPL_HISTORY, () => {});\n  } else {\n    replServer.setupHistory?.(NODE_REPL_HISTORY, () => {});\n  }\n}\n"],"mappings":"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","ignoreList":[]}